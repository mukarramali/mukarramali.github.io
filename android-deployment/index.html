<!DOCTYPE html><html><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link rel="preload" href="/bin/component---src-layouts-index-js-56c5b65e165a7b40b3c6.js" as="script"/><link rel="preload" href="/bin/component---src-templates-blog-post-js-f902355baf38f067968a.js" as="script"/><link rel="preload" href="/bin/path---android-deployment-d96399ed8847934f49ac.js" as="script"/><link rel="preload" href="/bin/app-01f848551fe16ec393f6.js" as="script"/><link rel="preload" href="/bin/commons-afb5782224ac01f1fa03.js" as="script"/><title data-react-helmet="true">CodeStack - Android Versioning Using Docker &amp; Git Like A Pro</title><meta data-react-helmet="true" name="description" content="Tech"/><meta data-react-helmet="true" name="keywords" content="tech, ideas"/><style id="gatsby-inlined-css">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:112.5%/1.45em georgia,serif;box-sizing:border-box;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{color:rgba(0,0,0,.8);font-family:georgia,serif;font-weight:400;word-wrap:break-word;-webkit-font-kerning:normal;font-kerning:normal;-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";font-feature-settings:"kern","liga","clig","calt","kern"}img{max-width:100%;margin:0 0 1.45rem;padding:0}h1{font-size:2.25rem}h1,h2{margin:0 0 1.45rem;padding:0;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{margin:0 0 1.45rem;padding:0;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{margin:0 0 1.45rem;padding:0;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h6{font-size:.78405rem}hgroup{margin:0 0 1.45rem;padding:0}ol,ul{margin:0 0 1.45rem 1.45rem;padding:0;list-style-position:outside;list-style-image:none}dd,dl,figure,p{margin:0 0 1.45rem;padding:0}pre{padding:0;font-size:.85rem;line-height:1.42;background:rgba(0,0,0,.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.45rem}pre,table{margin:0 0 1.45rem}table{padding:0;font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%}fieldset{margin:0 0 1.45rem;padding:0}blockquote{margin:0 1.45rem 1.45rem;padding:0}form,iframe,noscript{margin:0 0 1.45rem;padding:0}hr{margin:0 0 calc(1.45rem - 1px);padding:0;background:rgba(0,0,0,.2);border:none;height:1px}address{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-left:1.45rem;margin-bottom:.725rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace;padding:0;padding-top:.2em;padding-bottom:.2em}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{letter-spacing:-.2em;content:" "}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}*{background:#f5f5f5;color:#000}body,html{height:100%}body{border:5px solid #ffdb3a}h1{font-size:1.5rem;line-height:.5rem}div,p{font-size:16px}div.blog-post-preview{border-bottom:2px solid #e6e6e6;padding-top:1rem;padding-bottom:1rem;margin-bottom:1rem}h1>*{font-size:1.2rem;-webkit-text-decoration-line:none;text-decoration-line:none}h2{font-size:.8rem!important;font-weight:100!important}</style></head><body><div id="___gatsby"><div data-reactroot="" data-reactid="1" data-react-checksum="-634803525"><!-- react-empty: 2 --><div style="background:#f5f5f5;margin-bottom:3rem;border-bottom:2px solid #e6e6e6;" data-reactid="3"><div style="margin:0 auto;max-width:980px;padding:1.45rem 1.0875rem;" data-reactid="4"><h1 style="margin:0;text-align:center;font-size:18px;" data-reactid="5"><a style="color:black;text-decoration:none;" href="/bin/" data-reactid="6">Chai with Mukku</a></h1></div></div><div style="margin:0 auto;max-width:980px;display:flex;flex-direction:row;justify-content:space-between;height:100%;" data-reactid="7"><div style="margin:0 auto;max-width:980px;display:flex;flex-direction:row;justify-content:space-between;height:100%;padding:25px;" data-reactid="8"><div style="flex:1;" data-reactid="9"><div class="blog-post-container" data-reactid="10"><!-- react-empty: 11 --><div class="blog-post" data-reactid="12"><h1 data-reactid="13">Android Versioning Using Docker &amp; Git Like A Pro</h1><div class="blog-post-content" data-reactid="14"><p>Unlike web, android still lacks the ease of version deployments. Specially when you don't want to use Play Store.</p>
<p><img src="https://www.genymobile.com/wp-content/uploads/2015/07/Android-Docker.png" alt="alt text" title="Shipping Android Deployment"></p>
<h3>Introduction</h3>
<p>There will be five stages:</p>
<ol>
<li>Signing application</li>
<li>Versioning of application. For that we gonna use git revision and Major.Minor.Patch naming convention.</li>
<li>Building application using a docker. So that running environment doesn't change.</li>
<li>Pushing new release to s3, while maintaining the previous versions.</li>
<li>Pushing new tag to git, with the new version. So, we'll have tags for each version.</li>
</ol>
<p>Basically, we gonna use docker, git, and some simple hacks to put things in work. In the end, I've shared a sample application.</p>
<h3><em>Stage 1</em>: Signing Our Application</h3>
<p>It's better to start thinking about security right from the big bang.
From android studio, you can generate a new keystore, a jks file. <a href="https://developer.android.com/studio/publish/app-signing">Help?</a>
Copy the keystore file details in a <em>config.yaml</em> file like below:</p>
<pre><code class="language-yaml">key_store:
  key: /xyz/xyz.jks
  alias: key0
  store_password: wuhoo
  key_password: nibataunga
</code></pre>
<p>Studio will take care of signing, but to generate signed apk from command line, you'll need to make some changes in your build.gradle. The credentials we have put in above yaml file will be passed as command line args to gradle(Build stage[2]). </p>
<pre><code class="language-groovy">android {
    ...
    signingConfigs {
        release {
            if (project.hasProperty('APP_RELEASE_STORE_FILE')) {
                storeFile file("$APP_RELEASE_STORE_FILE")
                storePassword "$APP_RELEASE_STORE_PASSWORD"
                keyAlias "$APP_RELEASE_KEY_ALIAS"
                keyPassword "$APP_RELEASE_KEY_PASSWORD"
            }
        }
    }
    buildTypes {
        release {
          ...
          if (project.hasProperty('APP_RELEASE_STORE_FILE')) {
              signingConfig signingConfigs.release
          }
        }
    }
}
</code></pre>
<h3><em>Stage 2</em>: Release Versioning, Digging Git</h3>
<p>Let's follow the old school way.</p>
<p>Major.Minor.<em>GitRevision</em>.Patch</p>
<p>I won't go down the road to explain first two and the last one. Let's dig into GitRevision</p>
<p>GitRevision will make versioning easy and consistent. It counts the number of commits from git, so you'll get incremental values everytime you release a new version.</p>
<p>We'll put the below code in build.gradle[app]</p>
<pre><code class="language-groovy">def getGitRevision = { ->
    try {
        def stdout = new ByteArrayOutputStream()
        exec {
            standardOutput = stdout
            commandLine 'git', 'rev-list', '--first-parent', '--count', 'master'
        }
        logger.info("Building revision #"+stdout)
        return stdout.toString("ASCII").trim().toInteger()
    }
    catch (Exception e) {
        e.printStackTrace();
        return 0;
    }
}
</code></pre>
<p>And in build.gradle[app]</p>
<pre><code class="language-groovy">    defaultConfig {
        ...
        versionCode = 10000000*majorVersion+10000*minorVersion + 10*revision
        versionName = 'v' + majorVersion + '.' + minorVersion + '.' + revision + patch
    }
</code></pre>
<h3>Docker Image, Savage</h3>
<p>We first need to build a docker image with minimum libraries and dependencies required.</p>
<pre><code class="language-console">FROM openjdk:8
RUN apt-get update
RUN cd /opt/
RUN wget -nc https://dl.google.com/android/repository/sdk-tools-linux-4333796.zip
ENV ANDROID_HOME /opt/android-sdk-linux
RUN mkdir -p ${ANDROID_HOME}
RUN unzip -n -d ${ANDROID_HOME} sdk-tools-linux-4333796.zip
ENV PATH ${PATH}:${ANDROID_HOME}/tools:${ANDROID_HOME}/tools/bin:${ANDROID_HOME}/platform-tools
RUN yes | sdkmanager --licenses
RUN yes | sdkmanager \
      "platform-tools" \
      "build-tools;27.0.3" \
      "platforms;android-27"

RUN apt-get -y install ruby
RUN gem install trollop
</code></pre>
<p>Trollop will be helpful in compiling scripts, spicing the boring command line args.</p>
<p>We are using openjdk as base image for java environment and installed our sdk with version 27. You can change that accordingly.</p>
<h4>Building the image:</h4>
<pre><code class="language-console">docker build -t ${docker_image} -f ./scripts/Dockerfile .
</code></pre>
<p>Or you can directly pull my latest base image.</p>
<pre><code class="language-console">docker pull mukarramali98/androidbase
</code></pre>
<h3>Docker container on the way</h3>
<p>To automate the process, let's dig into a small script:</p>
<pre><code class="language-console">#!/usr/bin/env bash
set -xeuo pipefail

app_name=xyz
container_name=androidcontainer

if [ ! "$(docker ps -q -f name=${container_name})" ]; then
    if [ "$(docker ps -aq -f status=exited -f name=${container_name})" ]; then
        # cleanup
        docker rm $container_name
    fi
    # run your container
    docker run -v ${PWD}:/${app_name}/ --name ${container_name} -w /${app_name} -d -i -t mukarramali98/androidbase
fi

docker exec ${container_name} ruby /${app_name}/scripts/compile.rb -k /${app_name}/config.yaml
</code></pre>
<p>Here we first check if the container already exists. Then create accordingly.
While creating the container, we <em>mount</em> our current project directory. So next time we run this container, our updated project will already be there in the container.</p>
<h3><em>Stage 3</em>: Running container, <em>Build Stage</em></h3>
<p>We run the container, with our compile script. Pass the signing config file we created earlier.</p>
<pre><code class="language-ruby">config = YAML.load_file(key_config_file)

key_store = config['key_store']
output_file = 'app/build/outputs/apk/release/app-release.apk'
`rm #{output_file}` if File.exists?output_file

puts `#{File.dirname(__FILE__)}/../gradlew assembleRelease --stacktrace \
    -PAPP_RELEASE_STORE_FILE=#{key_store['key']} \
    -PAPP_RELEASE_KEY_ALIAS=#{key_store['alias']} \
    -PAPP_RELEASE_STORE_PASSWORD='#{key_store['store_password']}' \
    -PAPP_RELEASE_KEY_PASSWORD='#{key_store['key_password']}'`
</code></pre>
<h3><em>Stage 4</em>: Pushing to S3</h3>
<p>So, now we have build a signed apk from a docker container. It's time to push them.
Connect with your s3 bucket and generate <em>$HOME/.s3cfg</em> file, and pass it to ruby script below:</p>
<pre><code class="language-ruby">if File.file?(s3_config)
  # Push the generate apk file with the app and version name
  `s3cmd put app/build/outputs/apk/release/app-release.apk s3://#{bucket}/#{app_name}-#{version_name}.apk -m application/vnd.android.package-archive -f -P -c #{s3_config}`
  # application/vnd.android.package-archive is an apk file format descriptor

  # Replace the previous production file
  `s3cmd put app/build/outputs/apk/release/app-release.apk s3://#{bucket}/#{app_name}.apk -m application/vnd.android.package-archive -f -P -c #{s3_config}`

  # To keep the track of latest release
  `echo #{version_code}> latest_version.txt`
  `s3cmd put latest_version.txt s3://#{bucket}/latest_version.txt -f -P -c #{s3_config}`
  `rm latest_version.txt`
  puts "Successfully released new app version."
end
</code></pre>
<p><code>application/vnd.android.package-archive</code> is the apk file type descriptor.</p>
<h3><em>Stage 5</em>: Finally, Git Tagging The New Release Version, <em>#hashtag</em></h3>
<pre><code class="language-ruby">def push_new_tag version_name
  `git tag #{version_name}`
  `git push origin #{version_name}`
  puts "New tag pushed to repo."
end
</code></pre>
<h3><a href="https://github.com/mukarramali/android_deployment_example">Demo Application</a></h3>
<p>Releasing soon.</p></div></div></div></div></div></div></div></div><script id="webpack-manifest">/*<![CDATA[*/window.webpackManifest={"231608221292675":"app-01f848551fe16ec393f6.js","107818501498521":"component---src-templates-blog-post-js-f902355baf38f067968a.js","162898551421021":"component---src-pages-404-js-4503918ea3a16cfcdb75.js","35783957827783":"component---src-pages-index-js-4d47dce0042bb9357861.js","218538773642512":"component---src-pages-page-2-js-65f0147ecb0dc4da2a2b.js","60335399758886":"path----557518bd178906f8d58a.js","257462112702050":"path---android-deployment-d96399ed8847934f49ac.js","70575498362793":"path---lazy-sunday-a6eda1a7c04ae23e150f.js","254022195166212":"path---404-a0e39f21c11f6a62c5ab.js","142629428675168":"path---index-e5df67bbc6bb1f7924a2.js","135728916539164":"path---page-2-a0e39f21c11f6a62c5ab.js","178698757827068":"path---404-html-a0e39f21c11f6a62c5ab.js","114276838955818":"component---src-layouts-index-js-56c5b65e165a7b40b3c6.js"}/*]]>*/</script><script>/*<![CDATA[*/!function(e,t,r){function n(){for(;d[0]&&"loaded"==d[0][f];)c=d.shift(),c[o]=!i.parentNode.insertBefore(c,i)}for(var s,a,c,d=[],i=e.scripts[0],o="onreadystatechange",f="readyState";s=r.shift();)a=e.createElement(t),"async"in i?(a.async=!1,e.head.appendChild(a)):i[f]?(d.push(a),a[o]=n):e.write("<"+t+' src="'+s+'" defer></'+t+">"),a.src=s}(document,"script",["/bin/commons-afb5782224ac01f1fa03.js","/bin/app-01f848551fe16ec393f6.js","/bin/path---android-deployment-d96399ed8847934f49ac.js","/bin/component---src-templates-blog-post-js-f902355baf38f067968a.js","/bin/component---src-layouts-index-js-56c5b65e165a7b40b3c6.js"])/*]]>*/</script></body></html>